{% extends 'reviews/base.html' %}
{% load static %}

{% block title %}Search Movies - Movie Review API{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card animate-fade-in">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-search"></i> Search Movies</h4>
                </div>
                <div class="card-body">
                    <form id="movieSearchForm">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="searchQuery" placeholder="Enter movie title..." required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="searchResults" class="mt-4"></div>
    <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
        <!-- Skeleton Loader will be injected here -->
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Write a Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    {% csrf_token %}
                    <input type="hidden" id="movieTitle" name="movie_title">
                    <input type="hidden" id="movieImdbId" name="imdb_id">
                    
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <!-- Star Rating Component -->
                        <div class="mb-2" data-star-rating data-input="rating"></div>
                        <input type="hidden" id="rating" name="rating" required>
                        <small class="text-muted">Click the stars to rate</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reviewContent" class="form-label">Review</label>
                        <textarea class="form-control" id="reviewContent" name="review_content" rows="4" placeholder="Write your review here..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: var(--secondary-bg); border-color: var(--accent-gold); color: var(--text-light);">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReview">Submit Review</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Search movies
    $('#movieSearchForm').submit(function(e) {
        e.preventDefault();
        
        const query = $('#searchQuery').val().trim();
        if (!query) return;
        
        // Show skeleton loader
        $('#searchResults').empty();
        const skeletonLoader = window.createSkeletonLoader(6);
        $('#loadingSpinner').html('').append(skeletonLoader).show();
        
        $.ajax({
            url: '/api/search-movies/',
            method: 'GET',
            data: { search: query },
            success: function(data) {
                $('#loadingSpinner').hide();
                displaySearchResults(data);
            },
            error: function() {
                $('#loadingSpinner').hide();
                window.toast.error('Error searching movies. Please try again.');
            }
        });
    });
    
    // Display search results
    function displaySearchResults(movies) {
        if (movies.length === 0) {
            $('#searchResults').html('<div class="alert alert-info">No movies found. Try a different search term.</div>');
            return;
        }
        
        let html = '<div class="row">';
        movies.forEach(movie => {
            html += `
                <div class="col-md-6 col-lg-4 mb-4 animate-fade-in">
                    <div class="card movie-card h-100">
                        <img src="${movie.Poster !== 'N/A' ? movie.Poster : '/static/placeholder.jpg'}" 
                             class="card-img-top" alt="${movie.Title}" style="height: 300px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">${movie.Title}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> ${movie.Year}<br>
                                    <i class="fas fa-film"></i> ${movie.Type}
                                </small>
                            </p>
                            <button class="btn btn-primary btn-sm write-review-btn" 
                                    data-title="${movie.Title}" 
                                    data-imdb="${movie.imdbID}">
                                <i class="fas fa-star"></i> Write Review
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        $('#searchResults').html(html);
        
        // Bind review button clicks
        $('.write-review-btn').click(function() {
            const title = $(this).data('title');
            const imdbId = $(this).data('imdb');
            
            $('#movieTitle').val(title);
            $('#movieImdbId').val(imdbId);
            $('#reviewModal .modal-title').text(`Write a Review for "${title}"`);
            
            // Reset form and star rating
            $('#reviewForm')[0].reset();
            $('#rating').val('');
            const starRatingElement = document.querySelector('[data-star-rating]');
            if (starRatingElement && starRatingElement.starRatingInstance) {
                starRatingElement.starRatingInstance.setRating(0);
            }
            
            $('#reviewModal').modal('show');
        });
    }
    
    // Submit review
    $('#submitReview').click(function() {
        const formData = {
            movie_title: $('#movieTitle').val(),
            review_content: $('#reviewContent').val(),
            rating: parseInt($('#rating').val())
        };
        
        if (!formData.rating || !formData.review_content) {
            window.toast.warning('Please fill in all fields and select a rating');
            return;
        }
        
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrfToken = getCookie('csrftoken') || $('meta[name=csrf-token]').attr('content');
        
        // Show loading state with LoadingButton
        const submitBtn = $('#submitReview')[0];
        const loadingBtn = new window.LoadingButton(submitBtn);
        loadingBtn.start('Submitting...');
        
        $.ajax({
            url: '/api/reviews/',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify(formData),
            success: function(response) {
                loadingBtn.stop();
                $('#reviewModal').modal('hide');
                $('#reviewForm')[0].reset();
                window.toast.success('Review submitted successfully! ðŸŽ¬');
                
                // Refresh page after a short delay
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr, status, error) {
                loadingBtn.stop();
                
                let errorMessage = 'Error submitting review. Please try again.';
                
                if (xhr.responseText) {
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                window.toast.error(errorMessage);
            }
        });
    });
});
</script>
{% endblock %}
