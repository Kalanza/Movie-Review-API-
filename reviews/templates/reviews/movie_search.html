{% extends 'reviews/base.html' %}
{% load static %}

{% block title %}Search Movies - Movie Review API{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-search"></i> Search Movies</h4>
                </div>
                <div class="card-body">
                    <form id="movieSearchForm">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="searchQuery" placeholder="Enter movie title..." required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="searchResults" class="mt-4"></div>
    <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Write a Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    {% csrf_token %}
                    <input type="hidden" id="movieTitle" name="movie_title">
                    <input type="hidden" id="movieImdbId" name="imdb_id">
                    
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating</label>
                        <select class="form-select" id="rating" name="rating" required>
                            <option value="">Select rating...</option>
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Good</option>
                            <option value="4">4 - Very Good</option>
                            <option value="5">5 - Excellent</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reviewContent" class="form-label">Review</label>
                        <textarea class="form-control" id="reviewContent" name="review_content" rows="4" placeholder="Write your review here..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitReview">Submit Review</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Search movies
    $('#movieSearchForm').submit(function(e) {
        e.preventDefault();
        
        const query = $('#searchQuery').val().trim();
        if (!query) return;
        
        $('#loadingSpinner').show();
        $('#searchResults').empty();
        
        $.ajax({
            url: '/api/search-movies/',
            method: 'GET',
            data: { search: query },
            success: function(data) {
                $('#loadingSpinner').hide();
                displaySearchResults(data);
            },
            error: function() {
                $('#loadingSpinner').hide();
                $('#searchResults').html('<div class="alert alert-danger">Error searching movies. Please try again.</div>');
            }
        });
    });
    
    // Display search results
    function displaySearchResults(movies) {
        if (movies.length === 0) {
            $('#searchResults').html('<div class="alert alert-info">No movies found. Try a different search term.</div>');
            return;
        }
        
        let html = '<div class="row">';
        movies.forEach(movie => {
            html += `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card movie-card h-100">
                        <img src="${movie.Poster !== 'N/A' ? movie.Poster : '/static/placeholder.jpg'}" 
                             class="card-img-top" alt="${movie.Title}" style="height: 300px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">${movie.Title}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> ${movie.Year}<br>
                                    <i class="fas fa-film"></i> ${movie.Type}
                                </small>
                            </p>
                            <button class="btn btn-primary btn-sm write-review-btn" 
                                    data-title="${movie.Title}" 
                                    data-imdb="${movie.imdbID}">
                                <i class="fas fa-star"></i> Write Review
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        $('#searchResults').html(html);
        
        // Bind review button clicks
        $('.write-review-btn').click(function() {
            const title = $(this).data('title');
            const imdbId = $(this).data('imdb');
            
            $('#movieTitle').val(title);
            $('#movieImdbId').val(imdbId);
            $('#reviewModal .modal-title').text(`Write a Review for "${title}"`);
            $('#reviewModal').modal('show');
        });
    }
    
    // Submit review
    $('#submitReview').click(function() {
        console.log('Submit button clicked!'); // Debug log
        
        const formData = {
            movie_title: $('#movieTitle').val(),
            review_content: $('#reviewContent').val(),
            rating: parseInt($('#rating').val())
        };
        
        console.log('Form data collected:', formData); // Debug log
        console.log('Movie title:', formData.movie_title);
        console.log('Review content:', formData.review_content);
        console.log('Rating:', formData.rating);
        
        if (!formData.rating || !formData.review_content) {
            alert('Please fill in all fields');
            return;
        }
        
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrfToken = getCookie('csrftoken') || $('meta[name=csrf-token]').attr('content');
        console.log('CSRF Token:', csrfToken); // Debug log
        
        // Show loading state
        const submitBtn = $('#submitReview');
        const originalText = submitBtn.text();
        submitBtn.text('Submitting...').prop('disabled', true);
        
        $.ajax({
            url: '/api/reviews/',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: JSON.stringify(formData),
            beforeSend: function(xhr) {
                console.log('About to send request to:', '/api/reviews/');
                console.log('Request headers:', xhr.getAllResponseHeaders());
                console.log('Request data:', JSON.stringify(formData));
            },
            success: function(response) {
                console.log('SUCCESS! Response:', response);
                submitBtn.text(originalText).prop('disabled', false);
                $('#reviewModal').modal('hide');
                $('#reviewForm')[0].reset();
                alert('Review submitted successfully!');
                // Optionally refresh the page or update the UI
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('AJAX ERROR occurred:');
                console.error('Status:', status);
                console.error('Error:', error);
                console.error('Response Status:', xhr.status);
                console.error('Response Text:', xhr.responseText);
                console.error('Ready State:', xhr.readyState);
                
                submitBtn.text(originalText).prop('disabled', false);
                
                let errorMessage = 'Error submitting review. Please try again.';
                
                if (xhr.responseText) {
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        console.error('Parsed error data:', errorData);
                        
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        } else if (typeof errorData === 'object') {
                            errorMessage = JSON.stringify(errorData);
                        }
                    } catch (e) {
                        console.error('Could not parse error response as JSON');
                        errorMessage = xhr.responseText;
                    }
                }
                
                alert('Detailed Error: ' + errorMessage);
            }
        });
    });
});
</script>
{% endblock %}
